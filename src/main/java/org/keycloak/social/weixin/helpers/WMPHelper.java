package org.keycloak.social.weixin.helpers;

import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.stream.Stream;

import org.keycloak.broker.provider.BrokeredIdentityContext;
import org.keycloak.broker.provider.util.IdentityBrokerState;
import org.keycloak.models.ClientModel;
import org.keycloak.models.GroupModel;
import org.keycloak.models.KeycloakSession;
import org.keycloak.models.RealmModel;
import org.keycloak.models.RoleModel;
import org.keycloak.models.SubjectCredentialManager;
import org.keycloak.models.UserModel;
import org.keycloak.models.UserSessionModel;
import org.keycloak.services.managers.ClientSessionCode;
import org.keycloak.sessions.AuthenticationSessionModel;
import org.keycloak.social.weixin.AuthenticatedWMPSession;
import org.keycloak.social.weixin.WMPUserSessionModel;
import org.keycloak.social.weixin.WeiXinIdentityBrokerService;

public class WMPHelper {
    public static String createStateForWMP(String clientId, String tabId, String clientData) {
        return IdentityBrokerState.decoded("wmp", clientId, clientId, tabId, clientData).getEncoded();
    }

    public static UserSessionModel getUserSessionModel(BrokeredIdentityContext context, UserModel federatedUser, AuthenticationSessionModel authSession) {
        return new WMPUserSessionModel(context, federatedUser, authSession);
    }

    public static ClientSessionCode getClientSessionCode(WeiXinIdentityBrokerService weiXinIdentityBrokerService, RealmModel realmModel, KeycloakSession session, BrokeredIdentityContext context) {
        final UserModel userModel = new UserModel() {
            @Override
            public String getId() {
                return context.getId();
            }

            @Override
            public String getUsername() {
                return context.getUsername();
            }

            @Override
            public void setUsername(String s) {

            }

            @Override
            public Long getCreatedTimestamp() {
                return null;
            }

            @Override
            public void setCreatedTimestamp(Long aLong) {

            }

            @Override
            public boolean isEnabled() {
                return true;
            }

            @Override
            public void setEnabled(boolean b) {

            }

            @Override
            public void setSingleAttribute(String s, String s1) {

            }

            @Override
            public void setAttribute(String s, List<String> list) {

            }

            @Override
            public void removeAttribute(String s) {

            }

            @Override
            public String getFirstAttribute(String s) {
                return null;
            }

            @Override
            public Stream<String> getAttributeStream(String s) {
                List<String> attributeValues = this.getAttribute(s);

                return attributeValues.stream();
            }

            private List<String> getAttribute(String s) {
                return Collections.singletonList(context.getUserAttribute(s));
            }

            @Override
            public Map<String, List<String>> getAttributes() {
                return context.getAttributes();
            }

            @Override
            public Stream<String> getRequiredActionsStream() {
                return null;
            }

            @Override
            public void addRequiredAction(String s) {

            }

            @Override
            public void removeRequiredAction(String s) {

            }

            @Override
            public String getFirstName() {
                return context.getFirstName();
            }

            @Override
            public void setFirstName(String s) {

            }

            @Override
            public String getLastName() {
                return context.getLastName();
            }

            @Override
            public void setLastName(String s) {

            }

            @Override
            public String getEmail() {
                return context.getEmail();
            }

            @Override
            public void setEmail(String s) {

            }

            @Override
            public boolean isEmailVerified() {
                return true;
            }

            @Override
            public void setEmailVerified(boolean b) {

            }

            @Override
            public Stream<GroupModel> getGroupsStream() {
                return null;
            }

            @Override
            public void joinGroup(GroupModel groupModel) {

            }

            @Override
            public void leaveGroup(GroupModel groupModel) {

            }

            @Override
            public boolean isMemberOf(GroupModel groupModel) {
                return false;
            }

            @Override
            public String getFederationLink() {
                return null;
            }

            @Override
            public void setFederationLink(String s) {

            }

            @Override
            public String getServiceAccountClientLink() {
                return null;
            }

            @Override
            public void setServiceAccountClientLink(String s) {

            }

            @Override
            public SubjectCredentialManager credentialManager() {
                return null;
            }

            @Override
            public Stream<RoleModel> getRealmRoleMappingsStream() {
                return null;
            }

            @Override
            public Stream<RoleModel> getClientRoleMappingsStream(ClientModel clientModel) {
                return null;
            }

            @Override
            public boolean hasRole(RoleModel roleModel) {
                return false;
            }

            @Override
            public void grantRole(RoleModel roleModel) {

            }

            @Override
            public Stream<RoleModel> getRoleMappingsStream() {
                return Stream.<RoleModel>builder().build();
            }

            @Override
            public void deleteRoleMapping(RoleModel roleModel) {

            }
        };
        final AuthenticatedWMPSession wmpSession = new AuthenticatedWMPSession(session, weiXinIdentityBrokerService.realmModel, userModel);

        return new ClientSessionCode(session, realmModel, wmpSession);
    }
}
